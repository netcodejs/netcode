name: CI
env: 
  coverall: [netcode, template]
on:
    push:
        branches:
            - main
    workflow_dispatch:
    pull_request:
        branches:
            - main
jobs:
    build:
        name: ${{ matrix.os }} - Node.js v${{ matrix.node }}

        runs-on: ${{ matrix.os }}
        strategy:
            matrix:
                # node: ["10.x", "12.x", "14.x"]
                node: ["12.x"]
                # os: [ubuntu-latest, windows-latest, macOS-latest]
                os: [ubuntu-latest]

        steps:
            - name: Checkout repo
              uses: actions/checkout@v2

            - name: Use Node ${{ matrix.node }}
              uses: actions/setup-node@v2
              with:
                  node-version: ${{ matrix.node }}
                  registry-url: 'https://registry.npmjs.org'

            - name: Install deps and build (with cache)
              uses: bahmutov/npm-install@v1

            # - name: Lint
            #   run: yarn lint

            - name: Test
              run: yarn test:ci

            - name: Coveralls - ${{ coverall }}
              uses: coverallsapp/github-action@master
              with:
                github-token: ${{ secrets.GITHUB_TOKEN }}
                path-to-lcov: packages/${{ coverall }}/coverage/lcov.info
                base-path: packages/${{ coverall }}
                parallel: true
                flag-name: ${{ coverall }}

            - name: Coveralls - Finish
              uses: coverallsapp/github-action@master
              with:
                parallel-finished: true

            - name: Build
              run: yarn build:ci

            - name: Monorepo publish
              id: publish
              if: ${{ github.event_name == 'push' }}
              run: yarn lerna publish from-git --registry https://registry.npmjs.org/:_authToken=${NPM_TOKEN}
              env:
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

            - name: Deploy example ðŸš€
              uses: JamesIves/github-pages-deploy-action@4.1.4
              if: ${{ github.event_name == 'push' }}
              with:
                  branch: gh-pages # The branch the action should deploy to.
                  folder: package/netcode/example # The folder the action should deploy.
